window.Sentry=window.Sentry||{},"undefined"!=typeof Sentry&&Sentry.init?(Sentry.init({dsn:"https://examplePublicKey@o0.ingest.sentry.io/0",integrations:[],tracesSampleRate:1,ignoreErrors:["ResizeObserver loop limit exceeded","Network request failed","Failed to fetch"],beforeSend(t){if(t.exception&&t.exception.values){const e=t.exception.values[0];e.value&&e.value.includes("Unexpected end of attribute")&&(t.tags={...t.tags,type:"d3_svg_error"})}return t}}),console.log("[Sentry] Initialized")):window.Sentry={captureException:t=>console.error("[Sentry Fallback]",t),captureMessage:t=>console.log("[Sentry Fallback]",t)};const App={currentTab:"overview",async init(){try{document.body.classList.add("loading"),await DataProcessor.loadData(),this.initFilters(),this.initPWAComponents(),this.showDataSourceIndicator(),this.initTabs(),this.initRouter(),this.initSalaryToggles(),this.initMapControls(),this.initOffersCTA(),Charts.init(),Timeline.init(),DossierMetiers.init(),this.updateStats(),this.updateMetrics(),Charts.update(),window.addEventListener("dataFiltered",()=>{this.updateStats(),this.updateMetrics(),Charts.update(),Timeline.update(),DossierMetiers.update(),"map"===this.currentTab&&FranceMap.update()}),window.addEventListener("dataRefreshed",()=>{console.log("[App] Data refreshed, updating UI..."),this.updateStats(),this.updateMetrics(),Charts.update(),Timeline.update(),DossierMetiers.update(),"map"===this.currentTab&&FranceMap.update(),this.showDataSourceIndicator()}),window.Router&&Router.init(),document.body.classList.remove("loading"),console.log("[App] Application initialized successfully")}catch(t){console.error("[App] Failed to initialize:",t),document.body.classList.remove("loading"),window.ErrorToast&&(ErrorToast.init(),navigator.onLine?ErrorToast.showDataError(8e3):ErrorToast.showNetworkError(8e3)),document.body.classList.add("js-error");const e=document.querySelector(".content-area");e&&(e.innerHTML=`\n          <div style="text-align: center; padding: 50px; max-width: 500px; margin: 0 auto;">\n            <h2 style="color: #1e293b; margin-bottom: 16px;">Erreur de chargement</h2>\n            <p style="color: #64748b; margin-bottom: 24px;">${navigator.onLine?"Impossible de charger les donn√©es. Veuillez r√©essayer.":"Vous √™tes hors-ligne et aucune donn√©e n'est en cache."}</p>\n            <button onclick="window.location.reload()" style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">\n              Rafra√Æchir la page\n            </button>\n          </div>\n        `)}},initPWAComponents(){if(window.UpdateToast&&UpdateToast.init(),window.BottomSheet){BottomSheet.init();const t=DataProcessor.getData();t?.departments&&BottomSheet.setDepartmentData(t.departments)}window.SwipeNavigation&&SwipeNavigation.init(),console.log("[App] PWA components initialized")},showDataSourceIndicator(){"cache"===(DataProcessor.getDataSource?.()||"unknown")&&console.log("[App] Using cached data")},initFilters(){const t=DataProcessor.getData(),e=(t,e,a=null)=>{const n=document.getElementById(`filter-${t}-container`),r=document.getElementById(`filter-${t}-trigger`),s=document.getElementById(`filter-${t}-dropdown`),o=document.getElementById(`filter-${t}-chips`);if(!(n&&r&&s&&o))return;const i=(e,n=0)=>{if("string"==typeof e||e.label&&!e.items){const r="string"==typeof e?e:e.value||e.label,s="string"==typeof e?e:e.label,o=a?a(r):null,i=o?`style="color: ${o}; font-weight: bold; margin-right: 4px;"`:"";return`\n            <label class="filter-dropdown-item" style="padding-left: ${8+16*n}px">\n              <input type="checkbox" value="${r}" class="filter-${t}-cb" data-level="${n}">\n              ${i?`<span ${i}>‚óè</span>`:""}\n              ${s}\n            </label>\n          `}if(e.items){return`\n            <div class="filter-dropdown-group">\n              <label class="filter-dropdown-group-header" style="padding-left: ${8+16*n}px; font-weight: bold; background: var(--color-surface-alt); cursor: pointer;">\n                <input type="checkbox" class="filter-group-cb" value="${e.label}">\n                ${e.label}\n                 <span style="font-size: 0.8em; color: var(--color-text-muted); font-weight: normal; margin-left: 4px;">(${e.items.length})</span>\n              </label>\n              <div class="filter-dropdown-group-items">\n                ${e.items.map(t=>i(t,n+1)).join("")}\n              </div>\n            </div>\n          `}};s.innerHTML=e.map(t=>i(t)).join("");const l=()=>{const e=s.querySelectorAll(`.filter-${t}-cb:checked`);r.textContent=e.length>0?`${e.length} s√©lectionn√©${e.length>1?"s":""}`:"S√©lectionner...",e.length>0?r.style.borderColor="var(--color-primary)":r.style.borderColor="",o.innerHTML=Array.from(e).map(t=>`\n             <span class="filter-chip">\n               ${t.parentElement.textContent.replace("‚óè","").trim()}\n               <button class="filter-chip-remove" data-value="${t.value}">&times;</button>\n             </span>\n           `).join(""),o.querySelectorAll(".filter-chip-remove").forEach(e=>{e.addEventListener("click",e=>{const a=e.target.dataset.value,n=s.querySelector(`.filter-${t}-cb[value="${a}"]`);if(n){n.checked=!1;const t=n.closest(".filter-dropdown-group");if(t){const e=t.querySelector(".filter-group-cb");e&&(e.checked=!1)}l(),this.applyFilters()}})})};r.addEventListener("click",t=>{t.stopPropagation(),((t=!1)=>{if(t)s.classList.remove("active");else{const t=s.classList.contains("active");document.querySelectorAll(".filter-dropdown-menu").forEach(t=>t.classList.remove("active")),t||s.classList.add("active")}})()}),s.querySelectorAll(`.filter-${t}-cb`).forEach(t=>{t.addEventListener("change",t=>{l(),this.applyFilters()})}),s.querySelectorAll(".filter-group-cb").forEach(e=>{e.addEventListener("change",e=>{e.target.closest(".filter-dropdown-group").querySelectorAll(`.filter-${t}-cb`).forEach(t=>t.checked=e.target.checked),l(),this.applyFilters()})})};e("job-family",JobClassifier.getAllFamilyNames().sort((t,e)=>t.localeCompare(e,"fr")),t=>JobClassifier.getColor(t));const a=t=>{const e=t.match(/(\d+)\s*Mois/i);if(e)return 30*parseInt(e[1]);const a=t.match(/(\d+)\s*Jours?/i);return a?parseInt(a[1]):0},n=Object.keys(t.byContractType),r={CDI:[],CDD:[],"Int√©rim":[],Saisonnier:[],Autre:[]};n.forEach(t=>{t.startsWith("CDI")?r.CDI.push(t):t.startsWith("CDD")?r.CDD.push(t):t.startsWith("Int√©rim")?r["Int√©rim"].push(t):t.toLowerCase().includes("saisonnier")?r.Saisonnier.push(t):r.Autre.push(t)});const s=(t,e)=>a(e)-a(t);r.CDD.sort(s),r["Int√©rim"].sort(s),r.Saisonnier.sort(s),r.Autre.sort((t,e)=>t.localeCompare(e,"fr"));const o=[];r.CDI.length>0&&r.CDI.forEach(t=>o.push(t)),r.CDD.length>0&&o.push({label:"CDD",items:r.CDD}),r["Int√©rim"].length>0&&o.push({label:"Int√©rim",items:r["Int√©rim"]}),r.Saisonnier.length>0&&o.push({label:"Saisonnier",items:r.Saisonnier}),r.Autre.length>0&&o.push({label:"Autres",items:r.Autre}),e("contract",o),document.addEventListener("click",t=>{t.target.closest(".filter-dropdown-wrapper")||document.querySelectorAll(".filter-dropdown-menu").forEach(t=>t.classList.remove("active"))}),this.initDepartmentAutocomplete(t);const i=document.getElementById("reset-filters");i&&i.addEventListener("click",()=>{document.querySelectorAll(".filter-job-family-cb, .filter-contract-cb, .filter-group-cb").forEach(t=>{t.checked=!1}),["job-family","contract"].forEach(t=>{document.getElementById(`filter-${t}-trigger`).textContent="S√©lectionner...",document.getElementById(`filter-${t}-chips`).innerHTML="",document.getElementById(`filter-${t}-trigger`).style.borderColor=""});const t=document.getElementById("dept-search");t&&(t.value=""),this.clearSelectedDepartments(),DataProcessor.resetFilters()}),window.dispatchEvent(new CustomEvent("filtersReady")),console.log("[App] Filters initialized (Multi-select Refactor)")},initScrollIndicators(){document.querySelectorAll(".checkbox-group").forEach(t=>{const e=t.parentElement;if(!e?.classList.contains("checkbox-group-wrapper"))return;const a=()=>{const a=t.scrollHeight-t.scrollTop<=t.clientHeight+5;!(t.scrollHeight>t.clientHeight)||a?e.classList.add("scrolled-end"):e.classList.remove("scrolled-end")};t.addEventListener("scroll",a),setTimeout(a,100)})},selectedDepts:new Set,initDepartmentAutocomplete(t){const e=document.getElementById("dept-search"),a=document.getElementById("dept-dropdown"),n=document.getElementById("dept-chips");if(!e||!a||!n)return;const r=Object.entries(t.departments);let s=-1;const o=()=>{n.innerHTML=Array.from(this.selectedDepts).map(e=>{const a=t.departments[e];return`\n          <span class="dept-chip" data-code="${e}">\n            ${a} (${e})\n            <button class="dept-chip-remove" aria-label="Retirer ${a}">&times;</button>\n          </span>\n        `}).join(""),n.querySelectorAll(".dept-chip-remove").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.closest(".dept-chip").dataset.code;this.selectedDepts.delete(e),o(),this.applyFilters()})})},i=t=>{if(!t||t.length<1)return void(a.hidden=!0);const e=r.filter(([e,a])=>!this.selectedDepts.has(e)&&(e.toLowerCase().includes(t)||a.toLowerCase().includes(t))).slice(0,8);0===e.length?a.innerHTML='<div class="dept-no-results">Aucun r√©sultat</div>':a.innerHTML=e.map(([t,e],a)=>`\n          <div class="dept-option ${a===s?"highlighted":""}"\n               data-code="${t}"\n               data-index="${a}"\n               role="option">\n            <span class="dept-option-code">${t}</span>\n            ${e}\n          </div>\n        `).join(""),a.hidden=!1,a.querySelectorAll(".dept-option").forEach(t=>{t.addEventListener("click",()=>l(t.dataset.code))})},l=t=>{this.selectedDepts.add(t),e.value="",a.hidden=!0,s=-1,o(),this.applyFilters()};let c;e.addEventListener("input",t=>{clearTimeout(c),c=setTimeout(()=>{s=-1,i(t.target.value.toLowerCase())},100)}),e.addEventListener("keydown",t=>{const e=a.querySelectorAll(".dept-option");if("ArrowDown"===t.key)t.preventDefault(),s=Math.min(s+1,e.length-1),d(e);else if("ArrowUp"===t.key)t.preventDefault(),s=Math.max(s-1,0),d(e);else if("Enter"===t.key&&s>=0){t.preventDefault();const a=e[s]?.dataset.code;a&&l(a)}else"Escape"===t.key&&(a.hidden=!0,s=-1)});const d=t=>{t.forEach((t,e)=>{t.classList.toggle("highlighted",e===s)})};document.addEventListener("click",t=>{t.target.closest(".dept-autocomplete")||(a.hidden=!0)}),e.addEventListener("focus",()=>{e.value.length>=1&&i(e.value.toLowerCase())})},getSelectedDepartments(){return Array.from(this.selectedDepts)},clearSelectedDepartments(){this.selectedDepts.clear();const t=document.getElementById("dept-chips");t&&(t.innerHTML="")},applyFilters(){const t=Array.from(document.querySelectorAll(".filter-job-family-cb:checked")).map(t=>t.value),e=Array.from(document.querySelectorAll(".filter-contract-cb:checked")).map(t=>t.value),a=Array.from(this.selectedDepts);DataProcessor.applyFilters({jobFamilies:t,contractTypes:e,departments:a})},initTabs(){const t=document.querySelectorAll(".tab-btn"),e=document.querySelectorAll(".tab-content");t.forEach(a=>{a.addEventListener("click",()=>{const n=a.dataset.tab;t.forEach(t=>t.classList.remove("active")),a.classList.add("active"),e.forEach(t=>{t.classList.remove("active"),t.id===`tab-${n}`&&t.classList.add("active")}),this.currentTab=n,window.dispatchEvent(new CustomEvent("tabChanged",{detail:{tab:n}})),window.SwipeNavigation&&SwipeNavigation.setCurrentTab(n),"map"!==n||FranceMap.svg||FranceMap.init(),"sectors"===n&&(this.renderSectorTreemap(),this.renderSectorTable())})})},initRouter(){if(window.HashRouter){const t=HashRouter.getPath();this.handleRoute(t),window.addEventListener("hashRouteChanged",t=>{this.handleRoute(t.detail.path)})}},handleRoute(t){const e=t.replace("/","");let a="overview";if("map"===e||"carte"===e?a="map":"salaries"===e||"salaires"===e?a="salaries":"sectors"===e||"secteurs"===e?a="sectors":"dossier"===e&&(a="dossier"),a!==this.currentTab){const t=document.querySelector(`.tab-btn[data-tab="${a}"]`);t&&t.click()}},initSalaryToggles(){document.querySelectorAll("[data-salary-type]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-salary-type]").forEach(t=>t.classList.remove("active")),t.classList.add("active"),Charts.setSalaryType(t.dataset.salaryType)})}),document.querySelectorAll("[data-salary-period]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-salary-period]").forEach(t=>t.classList.remove("active")),t.classList.add("active"),Charts.setSalaryPeriod(t.dataset.salaryPeriod)})})},initMapControls(){document.querySelectorAll("[data-map-color]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-map-color]").forEach(t=>t.classList.remove("active")),t.classList.add("active"),FranceMap.setColorMode(t.dataset.mapColor)})})},initOffersCTA(){document.querySelectorAll(".btn-cta").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.context;let a=DataProcessor.getOffers(!0),n="Toutes les offres filtr√©es";"with-salary"===e&&(a=a.filter(t=>t.salaryNetMonthly),n="Offres avec salaire renseign√©"),OffersModal.show(a,n)})})},updateStats(){const t=DataProcessor.getData(),e=DataProcessor.getStats();document.getElementById("total-offers").textContent=SalaryUtils.formatNumber(e.total),document.getElementById("offers-with-salary").textContent=SalaryUtils.formatNumber(e.withSalary);const a=`${t.meta.dateRange.first.slice(5)} - ${t.meta.dateRange.last.slice(5)}`;document.getElementById("date-range").textContent=a},updateMetrics(){const t=DataProcessor.getStats();document.getElementById("metric-total").textContent=SalaryUtils.formatNumber(t.total),document.getElementById("metric-sectors").textContent=Object.keys(t.bySector).length,document.getElementById("metric-depts").textContent=Object.keys(t.byDepartment).length},colorblindPalette:["#0077BB","#EE7733","#009988","#CC3311","#33BBEE","#EE3377","#BBBBBB","#AA3377","#44BB99","#DDCC77","#882255","#332288","#117733","#999933","#CC6677"],sectorColors:{},renderSectorTreemap(){const t=document.getElementById("sector-treemap");if(!t)return;const e=DataProcessor.getStats(),a=Object.entries(e.bySector).filter(([t])=>"non pr√©cis√©"!==t.toLowerCase()).map(([t,e])=>({name:t,value:e.count})).sort((t,e)=>e.value-t.value).slice(0,20);t.innerHTML="";const n=t.clientWidth,r=d3.select(t).append("svg").attr("width",n).attr("height",400),s=d3.hierarchy({children:a}).sum(t=>t.value);d3.treemap().size([n,400]).padding(2)(s);const o=d3.scaleOrdinal(this.colorblindPalette);this.sectorColors={},a.forEach((t,e)=>{this.sectorColors[t.name]=o(e)});const i=r.selectAll("g").data(s.leaves()).enter().append("g").attr("transform",t=>`translate(${t.x0},${t.y0})`);i.append("rect").attr("width",t=>t.x1-t.x0).attr("height",t=>t.y1-t.y0).attr("fill",(t,e)=>o(e)).attr("rx",4).style("cursor","pointer").on("click",(t,e)=>{console.log("Clicked sector:",e.data.name)}),i.append("foreignObject").attr("x",4).attr("y",4).attr("width",t=>Math.max(0,t.x1-t.x0-8)).attr("height",t=>Math.max(0,t.y1-t.y0-8)).append("xhtml:div").style("width","100%").style("height","100%").style("display","flex").style("flex-direction","column").style("justify-content","flex-start").style("overflow","hidden").style("color","white").style("font-size","11px").style("line-height","1.2").style("pointer-events","none").html(t=>{const e=t.x1-t.x0,a=t.y1-t.y0;if(e<50||a<30)return"";const n=a>=45;return`\n          <div style="font-weight: 500; word-wrap: break-word; overflow-wrap: break-word;">${t.data.name}</div>\n          ${n?`<div style="opacity: 0.8; font-size: 10px; margin-top: 2px;">${t.data.value} offres</div>`:""}\n        `})},renderSectorTable(){const t=document.querySelector("#sector-table tbody");if(!t)return;const e=DataProcessor.getStats(),a=Object.entries(e.bySector).sort((t,e)=>e[1].count-t[1].count).slice(0,15);t.innerHTML=a.map(([t,e])=>`\n        <tr>\n          <td>\n            <span class="sector-color-dot" style="background-color: ${this.sectorColors[t]||"#BBBBBB"}"></span>\n            ${t}\n          </td>\n          <td>${e.count}</td>\n          <td>${e.salaryStats?`${SalaryUtils.formatCurrency(e.salaryStats.median)} <span class="count-badge">(n=${e.salaryStats.count})</span>`:"-"}</td>\n        </tr>\n      `).join("")}},Router=function(){const t={basePath:"",defaultTab:"overview",routes:{"/":"overview","/salaires":"salaries","/carte":"map","/secteurs":"sectors","/dossier":"dossier"},tabToPath:{overview:"/",salaries:"/salaires",map:"/carte",sectors:"/secteurs",dossier:"/dossier"},params:{jobFamilies:"famille",contractTypes:"contrat",departments:"dept"}};let e=!1,a=!1;function n(){let e=window.location.pathname;const a=new URLSearchParams(window.location.search),n=a.get("__route");if(n){a.delete("__route");const r=a.toString();e=decodeURIComponent(n);const s=t.basePath+e+(r?"?"+r:"");history.replaceState(null,"",s)}let s=e;t.basePath&&e.startsWith(t.basePath)&&(s=e.slice(t.basePath.length)||"/"),s=s.replace(/\/$/,"")||"/";return{tab:t.routes[s]||t.defaultTab,filters:{jobFamilies:r(a.get(t.params.jobFamilies)),contractTypes:r(a.get(t.params.contractTypes)),departments:r(a.get(t.params.departments))}}}function r(t){return t?t.split(",").map(t=>decodeURIComponent(t.trim())).filter(Boolean):[]}function s(t){return t&&0!==t.length?t.map(t=>encodeURIComponent(t)).join(","):null}function o(e,a){const n=t.tabToPath[e]||"/",r=t.basePath+n,o=new URLSearchParams;a.jobFamilies?.length&&o.set(t.params.jobFamilies,s(a.jobFamilies)),a.contractTypes?.length&&o.set(t.params.contractTypes,s(a.contractTypes)),a.departments?.length&&o.set(t.params.departments,s(a.departments));const i=o.toString();return r+(i?"?"+i:"")}function i(t,e=null,n=!1){if(a)return;a=!0,!e&&window.DataProcessor&&(e=DataProcessor.filters);const r=o(t,e=e||{jobFamilies:[],contractTypes:[],departments:[]});n?history.replaceState({tab:t,filters:e},"",r):history.pushState({tab:t,filters:e},"",r),a=!1}function l(t,e=!0){if(a)return;a=!0;const n=document.querySelector(`.tab-btn[data-tab="${t.tab}"]`);n&&!n.classList.contains("active")&&n.click();(t.filters.jobFamilies.length>0||t.filters.contractTypes.length>0||t.filters.departments.length>0)&&window.DataProcessor&&(DataProcessor.applyFilters(t.filters),function(t){const e=document.getElementById("filter-job-family");e&&e.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=t.jobFamilies.includes(e.value)});const a=document.getElementById("filter-contract");a&&a.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=t.contractTypes.includes(e.value)});window.BottomSheet&&BottomSheet.syncWithSidebar&&BottomSheet.syncWithSidebar()}(t.filters)),a=!1}function c(t){if(t.state)l(t.state);else{l(n())}}function d(t){if(a)return;const e=t.detail?.tab;e&&i(e,null,!1)}function u(t){if(a)return;const e=t.detail?.filters,n=window.App?.currentTab||"overview";e&&i(n,e,!0)}return{init:function(){if(e)return;!function(){const e=window.location.pathname,a=document.querySelector("base");if(a&&a.href){const e=new URL(a.href);return void(t.basePath=e.pathname.replace(/\/$/,""))}if(window.location.hostname.endsWith(".github.io")){const a=e.split("/").filter(Boolean);if(a.length>0){const e="/"+a[0];t.routes[e]||(t.basePath=e)}}}();const a=n();setTimeout(()=>{l(a,!1)},0),window.addEventListener("popstate",c),window.addEventListener("tabChanged",d),window.addEventListener("dataFiltered",u),e=!0,console.log("[Router] Initialized with basePath:",t.basePath)},navigate:i,parseCurrentURL:n,buildURL:o,getShareableURL:function(){const t=window.App?.currentTab||"overview",e=window.DataProcessor?.filters||{jobFamilies:[],contractTypes:[],departments:[]};return window.location.origin+o(t,e)},setBasePath:function(e){t.basePath=e.replace(/\/$/,"")},getCurrentRoute:function(){return n()}}}();window.Router=Router;const Storage=function(){let t=null;const e={OFFERS:"offers",DEPARTMENTS:"departments",META:"meta",PREFERENCES:"preferences"};async function a(){return new Promise((a,n)=>{if(t)return void a(t);const r=indexedDB.open("CepidInfovizDB",1);r.onerror=()=>{console.error("[Storage] Failed to open database:",r.error),n(r.error)},r.onsuccess=()=>{t=r.result,console.log("[Storage] Database opened successfully"),a(t)},r.onupgradeneeded=t=>{const a=t.target.result;if(console.log("[Storage] Upgrading database schema"),!a.objectStoreNames.contains(e.OFFERS)){const t=a.createObjectStore(e.OFFERS,{keyPath:"id"});t.createIndex("jobFamily","jobFamily",{unique:!1}),t.createIndex("department","department",{unique:!1}),t.createIndex("contractType","contractType",{unique:!1}),t.createIndex("date","date",{unique:!1})}a.objectStoreNames.contains(e.DEPARTMENTS)||a.createObjectStore(e.DEPARTMENTS,{keyPath:"code"}),a.objectStoreNames.contains(e.META)||a.createObjectStore(e.META,{keyPath:"key"}),a.objectStoreNames.contains(e.PREFERENCES)||a.createObjectStore(e.PREFERENCES,{keyPath:"key"})}})}async function n(n){return await a(),new Promise((a,r)=>{const s=t.transaction([e.OFFERS],"readwrite"),o=s.objectStore(e.OFFERS);o.clear();let i=0;n.forEach(t=>{o.put(t),i++}),s.oncomplete=()=>{console.log(`[Storage] Saved ${i} offers`),a(i)},s.onerror=()=>{console.error("[Storage] Failed to save offers:",s.error),r(s.error)}})}async function r(){return await a(),new Promise((a,n)=>{const r=t.transaction([e.OFFERS],"readonly").objectStore(e.OFFERS).getAll();r.onsuccess=()=>{a(r.result)},r.onerror=()=>{console.error("[Storage] Failed to get offers:",r.error),n(r.error)}})}async function s(n){return await a(),new Promise((a,r)=>{const s=t.transaction([e.DEPARTMENTS],"readwrite"),o=s.objectStore(e.DEPARTMENTS);o.clear(),Object.entries(n).forEach(([t,e])=>{o.put({code:t,name:e})}),s.oncomplete=()=>{console.log("[Storage] Saved departments"),a()},s.onerror=()=>{r(s.error)}})}async function o(){return await a(),new Promise((a,n)=>{const r=t.transaction([e.DEPARTMENTS],"readonly").objectStore(e.DEPARTMENTS).getAll();r.onsuccess=()=>{const t={};r.result.forEach(e=>{t[e.code]=e.name}),a(t)},r.onerror=()=>{n(r.error)}})}async function i(n,r){return await a(),new Promise((a,s)=>{const o=t.transaction([e.META],"readwrite");o.objectStore(e.META).put({key:n,value:r,updatedAt:(new Date).toISOString()}),o.oncomplete=()=>{a()},o.onerror=()=>{s(o.error)}})}async function l(n){return await a(),new Promise((a,r)=>{const s=t.transaction([e.META],"readonly").objectStore(e.META).get(n);s.onsuccess=()=>{a(s.result?s.result.value:null)},s.onerror=()=>{r(s.error)}})}async function c(t){await i("generatedAt",t.generatedAt),await i("dataSource",t.dataSource),await i("totalOffers",t.totalOffers),await i("offersWithSalary",t.offersWithSalary),await i("dateRange",t.dateRange)}async function d(){return{generatedAt:await l("generatedAt"),dataSource:await l("dataSource"),totalOffers:await l("totalOffers"),offersWithSalary:await l("offersWithSalary"),dateRange:await l("dateRange")}}return{init:a,saveOffers:n,getOffers:r,getOffersByJobFamily:async function(n){return await a(),new Promise((a,r)=>{const s=t.transaction([e.OFFERS],"readonly").objectStore(e.OFFERS).index("jobFamily").getAll(n);s.onsuccess=()=>{a(s.result)},s.onerror=()=>{r(s.error)}})},getOffersByDepartment:async function(n){return await a(),new Promise((a,r)=>{const s=t.transaction([e.OFFERS],"readonly").objectStore(e.OFFERS).index("department").getAll(n);s.onsuccess=()=>{a(s.result)},s.onerror=()=>{r(s.error)}})},saveDepartments:s,getDepartments:o,saveMeta:i,getMeta:l,saveAllMeta:c,getAllMeta:d,savePreference:async function(n,r){return await a(),new Promise((a,s)=>{const o=t.transaction([e.PREFERENCES],"readwrite");o.objectStore(e.PREFERENCES).put({key:n,value:r}),o.oncomplete=()=>{a()},o.onerror=()=>{s(o.error)}})},getPreference:async function(n,r=null){return await a(),new Promise((a,s)=>{const o=t.transaction([e.PREFERENCES],"readonly").objectStore(e.PREFERENCES).get(n);o.onsuccess=()=>{a(o.result?o.result.value:r)},o.onerror=()=>{s(o.error)}})},saveAggregatedData:async function(t){console.log("[Storage] Saving aggregated data...");const e=Date.now();await n(t.offers),await s(t.departments),await c(t.meta),await i("dates",t.dates),await i("byContractType",t.byContractType),await i("byJobFamily",t.byJobFamily);const a=Date.now()-e;console.log(`[Storage] Saved aggregated data in ${a}ms`)},loadAggregatedData:async function(){console.log("[Storage] Loading aggregated data from IndexedDB...");const t=Date.now();try{const e=await r();if(!e||0===e.length)return console.log("[Storage] No cached data found"),null;const a={meta:await d(),dates:await l("dates"),departments:await o(),offers:e,byContractType:await l("byContractType"),byJobFamily:await l("byJobFamily")},n=Date.now()-t;return console.log(`[Storage] Loaded ${e.length} offers from IndexedDB in ${n}ms`),a}catch(t){return console.error("[Storage] Failed to load data:",t),null}},hasData:async function(){try{return await a(),new Promise(a=>{const n=t.transaction([e.OFFERS],"readonly").objectStore(e.OFFERS).count();n.onsuccess=()=>{a(n.result>0)},n.onerror=()=>{a(!1)}})}catch(t){return!1}},getDataVersion:async function(){return l("generatedAt")},clearAll:async function(){return await a(),new Promise((a,n)=>{const r=t.transaction([e.OFFERS,e.DEPARTMENTS,e.META],"readwrite");r.objectStore(e.OFFERS).clear(),r.objectStore(e.DEPARTMENTS).clear(),r.objectStore(e.META).clear(),r.oncomplete=()=>{console.log("[Storage] All data cleared"),a()},r.onerror=()=>{n(r.error)}})},getStorageEstimate:async function(){if(navigator.storage&&navigator.storage.estimate){const t=await navigator.storage.estimate();return{usage:t.usage,quota:t.quota,percentUsed:(t.usage/t.quota*100).toFixed(2)}}return null},STORES:e}}();window.Storage=Storage;const DataProcessor={data:null,filteredOffers:null,isOffline:!navigator.onLine,dataSource:"none",filters:{jobFamilies:[],contractTypes:[],departments:[],dateRange:null},async loadData(){if(console.log("[DataProcessor] Loading data..."),this.setupOnlineListeners(),navigator.onLine)try{const t=await this.fetchFromNetwork();if(t)return this.data=t,this.filteredOffers=[...this.data.offers],this.dataSource="network",this.saveToStorage(t),this.data}catch(t){console.warn("[DataProcessor] Network fetch failed:",t.message)}const t=await this.loadFromStorage();if(t)return this.data=t,this.filteredOffers=[...this.data.offers],this.dataSource="cache",console.log("[DataProcessor] Loaded from IndexedDB cache"),this.data;throw new Error("No data available. Please connect to the internet.")},async fetchFromNetwork(){console.log("[DataProcessor] Fetching from network...");const t=await fetch("data/aggregated.json");if(!t.ok)throw new Error("Network response not ok");return t.json()},async saveToStorage(t){try{await Storage.saveAggregatedData(t),console.log("[DataProcessor] Data saved to IndexedDB")}catch(t){console.error("[DataProcessor] Failed to save to IndexedDB:",t)}},async loadFromStorage(){try{return await Storage.loadAggregatedData()}catch(t){return console.error("[DataProcessor] Failed to load from IndexedDB:",t),null}},setupOnlineListeners(){window.addEventListener("online",()=>{console.log("[DataProcessor] Back online"),this.isOffline=!1,this.updateOfflineIndicator(!1),this.refreshIfNeeded()}),window.addEventListener("offline",()=>{console.log("[DataProcessor] Gone offline"),this.isOffline=!0,this.updateOfflineIndicator(!0)}),this.updateOfflineIndicator(!navigator.onLine)},updateOfflineIndicator(t){const e=document.getElementById("offline-indicator");e&&(e.hidden=!t)},async refreshIfNeeded(){if("cache"===this.dataSource)try{const t=await this.fetchFromNetwork();if(t){const e=this.data.meta?.generatedAt,a=t.meta?.generatedAt;a&&(!e||a>e)&&(console.log("[DataProcessor] Newer data available, refreshing..."),this.data=t,this.filteredOffers=[...this.data.offers],this.dataSource="network",this.saveToStorage(t),window.dispatchEvent(new CustomEvent("dataRefreshed",{detail:{offers:this.filteredOffers}})))}}catch(t){console.warn("[DataProcessor] Background refresh failed:",t)}},hasCachedData:async()=>Storage.hasData(),getDataSource(){return this.dataSource},getData(){return this.data},getOffers(t=!0){return t?this.filteredOffers:this.data.offers},applyFilters(t){this.filters={...this.filters,...t},this.filteredOffers=this.data.offers.filter(t=>!(this.filters.jobFamilies.length>0&&!this.filters.jobFamilies.includes(t.jobFamily))&&(!(this.filters.contractTypes.length>0&&!this.filters.contractTypes.includes(t.contractType))&&!(this.filters.departments.length>0&&!this.filters.departments.includes(t.department)))),window.dispatchEvent(new CustomEvent("dataFiltered",{detail:{offers:this.filteredOffers,filters:this.filters}}))},resetFilters(){this.filters={jobFamilies:[],contractTypes:[],departments:[],dateRange:null},this.filteredOffers=[...this.data.offers],window.dispatchEvent(new CustomEvent("dataFiltered",{detail:{offers:this.filteredOffers,filters:this.filters}}))},getStats(){const t=this.filteredOffers,e=t.filter(t=>null!==t.salaryGrossAnnual),a={};t.forEach(t=>{a[t.jobFamily]||(a[t.jobFamily]={count:0,salaries:[]}),a[t.jobFamily].count++,t.salaryGrossAnnual&&a[t.jobFamily].salaries.push(t.salaryGrossAnnual)});for(const t in a)a[t].salaryStats=SalaryUtils.calculateStats(a[t].salaries),delete a[t].salaries;const n={};t.forEach(t=>{const e=t.contractType||"Non pr√©cis√©";n[e]||(n[e]={count:0,salaries:[]}),n[e].count++,t.salaryGrossAnnual&&n[e].salaries.push(t.salaryGrossAnnual)});for(const t in n)n[t].salaryStats=SalaryUtils.calculateStats(n[t].salaries),delete n[t].salaries;const r={};t.forEach(t=>{const e=t.department||"Inconnu";r[e]||(r[e]={name:this.data.departments[e]||e,count:0,salaries:[]}),r[e].count++,t.salaryGrossAnnual&&r[e].salaries.push(t.salaryGrossAnnual)});for(const t in r)r[t].salaryStats=SalaryUtils.calculateStats(r[t].salaries),delete r[t].salaries;const s={};t.forEach(t=>{const e=t.sector||"Non pr√©cis√©";s[e]||(s[e]={count:0,salaries:[]}),s[e].count++,t.salaryGrossAnnual&&s[e].salaries.push(t.salaryGrossAnnual)});for(const t in s)s[t].salaryStats=SalaryUtils.calculateStats(s[t].salaries),delete s[t].salaries;return{total:t.length,withSalary:e.length,byJobFamily:a,byContractType:n,byDepartment:r,bySector:s}},getOffersByDate(){const t={};return this.filteredOffers.forEach(e=>{t[e.date]||(t[e.date]=[]),t[e.date].push(e)}),t},getTopEmployers(t=10){const e={};return this.filteredOffers.forEach(t=>{t.company&&(e[t.company]=(e[t.company]||0)+1)}),Object.entries(e).sort((t,e)=>e[1]-t[1]).slice(0,t).map(([t,e])=>({name:t,count:e}))},getUniqueValues(t){const e=new Set;return this.data.offers.forEach(a=>{a[t]&&e.add(a[t])}),Array.from(e).sort()}};window.DataProcessor=DataProcessor;const Charts={instances:{},salaryType:"gross",salaryPeriod:"annual",init(){this.createJobFamilyChart(),this.createContractChart(),this.createSalaryContractChart(),this.createSalaryFamilyChart(),this.createSalaryDeptChart()},update(){const t=DataProcessor.getStats();this.updateJobFamilyChart(t),this.updateContractChart(t),this.updateSalaryContractChart(t),this.updateSalaryFamilyChart(t),this.updateSalaryDeptChart(t),this.updateSalaryTable(t)},destroyChart(t){this.instances[t]&&(this.instances[t].destroy(),delete this.instances[t])},createJobFamilyChart(){const t=document.getElementById("chart-job-families");t&&(this.destroyChart("jobFamilies"),this.instances.jobFamilies=new Chart(t,{type:"doughnut",data:{labels:[],datasets:[{data:[],backgroundColor:JobClassifier.getColorPalette()}]},options:{responsive:!0,plugins:{legend:{position:"right",labels:{boxWidth:12,font:{size:11}}}}}}))},updateJobFamilyChart(t){if(!this.instances.jobFamilies)return;const e=Object.entries(t.byJobFamily).sort((t,e)=>e[1].count-t[1].count);this.instances.jobFamilies.data.labels=e.map(t=>t[0]),this.instances.jobFamilies.data.datasets[0].data=e.map(t=>t[1].count),this.instances.jobFamilies.data.datasets[0].backgroundColor=e.map(t=>JobClassifier.getColor(t[0])),this.instances.jobFamilies.update()},createContractChart(){const t=document.getElementById("chart-contracts");t&&(this.destroyChart("contracts"),this.instances.contracts=new Chart(t,{type:"pie",data:{labels:[],datasets:[{data:[],backgroundColor:["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#64748b"]}]},options:{responsive:!0,plugins:{legend:{position:"right",labels:{boxWidth:12,font:{size:11}}}}}}))},updateContractChart(t){if(!this.instances.contracts)return;const e=Object.entries(t.byContractType).sort((t,e)=>e[1].count-t[1].count).slice(0,6);this.instances.contracts.data.labels=e.map(t=>t[0]),this.instances.contracts.data.datasets[0].data=e.map(t=>t[1].count),this.instances.contracts.update()},ensureWrapper(t){if(t.parentNode.classList.contains("chart-scroll-wrapper"))return t.parentNode;const e=document.createElement("div");return e.className="chart-scroll-wrapper",e.style.position="relative",e.style.width="100%",t.parentNode.insertBefore(e,t),e.appendChild(t),e},createSalaryContractChart(){const t=document.getElementById("chart-salary-contract");if(!t)return;this.ensureWrapper(t);const e=t.getContext("2d");this.destroyChart("salaryContract"),this.instances.salaryContract=new Chart(e,{type:"bar",data:{labels:[],datasets:[{label:"Salaire m√©dian",data:[],counts:[],backgroundColor:"#2563eb"}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{label:t=>{const e=t.dataset.counts?.[t.dataIndex];return`${SalaryUtils.formatCurrency(t.raw)} (n=${e||0})`}}}},scales:{x:{ticks:{callback:t=>SalaryUtils.formatCurrency(t)}},y:{border:{display:!0,color:"#cbd5e1",width:2},grid:{display:!1},ticks:{autoSkip:!1,font:{size:11},crossAlign:"near",padding:10}}}}})},updateSalaryContractChart(t){if(!this.instances.salaryContract)return;this.getSalaryKey();const e=Object.entries(t.byContractType).filter(t=>t[1].salaryStats).map(([t,e])=>({name:t,value:this.convertSalary(e.salaryStats.median),count:e.salaryStats.count})).sort((t,e)=>t.name.localeCompare(e.name,"fr",{sensitivity:"base"})),a=this.instances.salaryContract.ctx.canvas,n=a.parentNode,r=Math.max(200,60*e.length);console.log("[Charts:Debug] updateSalaryContractChart called",{dataLength:e.length,newHeight:r,currentWrapperHeight:n.style.height}),n.style.height=`${r}px`,a.style.height="100%",a.style.maxHeight="none",this.instances.salaryContract.data.labels=e.map(t=>t.name),this.instances.salaryContract.data.datasets[0].data=e.map(t=>t.value),this.instances.salaryContract.data.datasets[0].counts=e.map(t=>t.count),this.instances.salaryContract.data.datasets[0].label=SalaryUtils.getLabel(this.salaryType,this.salaryPeriod),this.instances.salaryContract.update()},createSalaryFamilyChart(){const t=document.getElementById("chart-salary-family");if(!t)return;this.ensureWrapper(t);const e=t.getContext("2d");this.destroyChart("salaryFamily"),this.instances.salaryFamily=new Chart(e,{type:"bar",data:{labels:[],datasets:[{label:"Salaire m√©dian",data:[],counts:[],backgroundColor:[]}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{label:t=>{const e=t.dataset.counts?.[t.dataIndex];return`${SalaryUtils.formatCurrency(t.raw)} (n=${e||0})`}}}},scales:{x:{ticks:{callback:t=>SalaryUtils.formatCurrency(t)}},y:{border:{display:!0,color:"#cbd5e1",width:2},grid:{display:!1},ticks:{autoSkip:!1,crossAlign:"near"}}}}})},updateSalaryFamilyChart(t){if(!this.instances.salaryFamily)return;const e=Object.entries(t.byJobFamily).filter(t=>t[1].salaryStats).map(([t,e])=>({name:t,value:this.convertSalary(e.salaryStats.median),count:e.salaryStats.count,color:JobClassifier.getColor(t)})).sort((t,e)=>t.name.localeCompare(e.name,"fr",{sensitivity:"base"})),a=this.instances.salaryFamily.ctx.canvas,n=a.parentNode,r=Math.max(200,60*e.length);n.style.height=`${r}px`,a.style.height="100%",a.style.maxHeight="none",this.instances.salaryFamily.data.labels=e.map(t=>t.name),this.instances.salaryFamily.data.datasets[0].data=e.map(t=>t.value),this.instances.salaryFamily.data.datasets[0].counts=e.map(t=>t.count),this.instances.salaryFamily.data.datasets[0].backgroundColor=e.map(t=>t.color),this.instances.salaryFamily.data.datasets[0].label=SalaryUtils.getLabel(this.salaryType,this.salaryPeriod),this.instances.salaryFamily.update()},createSalaryDeptChart(){const t=document.getElementById("chart-salary-dept");if(!t)return;this.ensureWrapper(t);const e=t.getContext("2d");this.destroyChart("salaryDept"),this.instances.salaryDept=new Chart(e,{type:"bar",data:{labels:[],datasets:[{label:"Salaire m√©dian",data:[],counts:[],backgroundColor:"#10b981"}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1},tooltip:{callbacks:{label:t=>{const e=t.dataset.counts?.[t.dataIndex];return`${SalaryUtils.formatCurrency(t.raw)} (n=${e||0})`}}}},scales:{x:{ticks:{callback:t=>SalaryUtils.formatCurrency(t)}},y:{border:{display:!0,color:"#cbd5e1",width:2},grid:{display:!1},ticks:{autoSkip:!1,crossAlign:"near"}}}}})},updateSalaryDeptChart(t){if(!this.instances.salaryDept)return;const e=Object.entries(t.byDepartment).filter(t=>t[1].salaryStats).map(([t,e])=>({name:`${e.name} (${t})`,value:this.convertSalary(e.salaryStats.median),count:e.salaryStats.count})).sort((t,e)=>e.value-t.value).sort((t,e)=>t.name.localeCompare(e.name,"fr",{sensitivity:"base"})),a=this.instances.salaryDept.ctx.canvas,n=a.parentNode,r=Math.max(200,60*e.length);n.style.height=`${r}px`,a.style.height="100%",a.style.maxHeight="none",this.instances.salaryDept.data.labels=e.map(t=>t.name),this.instances.salaryDept.data.datasets[0].data=e.map(t=>t.value),this.instances.salaryDept.data.datasets[0].counts=e.map(t=>t.count),this.instances.salaryDept.data.datasets[0].label=SalaryUtils.getLabel(this.salaryType,this.salaryPeriod),this.instances.salaryDept.update()},updateSalaryTable(t){const e=document.querySelector("#salary-summary-table tbody");if(!e)return;const a=Object.entries(t.byJobFamily).sort((t,e)=>e[1].count-t[1].count);e.innerHTML=a.map(([t,e])=>{const a=e.salaryStats;return`\n        <tr>\n          <td><span style="color: ${JobClassifier.getColor(t)};">‚óè</span> ${t}</td>\n          <td>${e.count}</td>\n          <td>${a?a.count:0}</td>\n          <td>${a?SalaryUtils.formatCurrency(this.convertSalary(a.min)):"-"}</td>\n          <td><strong>${a?SalaryUtils.formatCurrency(this.convertSalary(a.median)):"-"}</strong>${a?` <span class="count-badge">(n=${a.count})</span>`:""}</td>\n          <td>${a?SalaryUtils.formatCurrency(this.convertSalary(a.max)):"-"}</td>\n        </tr>\n      `}).join("")},convertSalary(t){if(!t)return null;let e=t;return"net"===this.salaryType&&(e=SalaryUtils.grossToNet(e)),"monthly"===this.salaryPeriod&&(e=SalaryUtils.annualToMonthly(e)),e},getSalaryKey(){return`salary${this.salaryType.charAt(0).toUpperCase()+this.salaryType.slice(1)}${this.salaryPeriod.charAt(0).toUpperCase()+this.salaryPeriod.slice(1)}`},setSalaryType(t){this.salaryType=t,this.update()},setSalaryPeriod(t){this.salaryPeriod=t,this.update()}};window.Charts=Charts;const FranceMap={svg:null,projection:null,path:null,colorScale:null,colorMode:"count",selectedDepts:[],tooltip:null,async init(){const t=document.getElementById("france-map");if(!t)return;t.innerHTML="";const e=t.clientWidth,a=getComputedStyle(document.documentElement),n=parseInt(a.getPropertyValue("--map-height-desktop").trim())||380,r=Math.min(t.clientHeight||n,n);this.svg=d3.select(t).append("svg").attr("width",e).attr("height",r).attr("viewBox",`0 0 ${e} ${r}`),this.tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);try{const t=await fetch("data/france-topo.json"),a=await t.json(),n=20;this.projection=d3.geoMercator().fitExtent([[n,n],[e-n,r-n]],a),this.path=d3.geoPath().projection(this.projection),this.drawMap(a),this.update()}catch(e){console.error("Error loading map data:",e),t.innerHTML='<p class="loading">Erreur de chargement de la carte</p>'}},drawMap(t){this.svg.append("g").attr("class","departments").selectAll("path").data(t.features).enter().append("path").attr("d",this.path).attr("class","department").attr("data-code",t=>t.properties.code).attr("fill","#e2e8f0").attr("stroke","#fff").attr("stroke-width",.5).on("mouseover",(t,e)=>this.handleMouseOver(t,e)).on("mouseout",()=>this.handleMouseOut()).on("click",(t,e)=>this.handleClick(e))},update(){const t=DataProcessor.getStats().byDepartment;let e;e="count"===this.colorMode?Object.values(t).map(t=>t.count):Object.values(t).filter(t=>t.salaryStats).map(t=>t.salaryStats.median);const a=Math.max(...e,1);this.colorScale=d3.scaleSequential().domain([0,a]).interpolator("count"===this.colorMode?d3.interpolate("#e0e7ff","#2563eb"):d3.interpolate("#fef3c7","#1d4ed8"));const n=this;this.svg.selectAll(".department").transition().duration(300).attr("fill",function(){const e=this.getAttribute("data-code"),a=t[e];return a?"count"===n.colorMode?n.colorScale(a.count):a.salaryStats?n.colorScale(a.salaryStats.median):"#f1f5f9":"#f1f5f9"}),this.updateLegend(a)},updateLegend(t){const e=document.getElementById("map-legend");if(!e)return;const a="count"===this.colorMode?"Nombre d'offres":"Salaire m√©dian",n="salary"===this.colorMode,r=n?t=>0===t?"NC":SalaryUtils.formatCurrency(t,!0):t=>Math.round(t),s=n?[.25,.5,.75,1]:[0,.25,.5,.75,1];e.innerHTML=`\n      <h4>${a}</h4>\n      <div style="display: flex; flex-direction: column; gap: 4px;">\n        ${s.map(e=>{const a=e*t;return`\n            <div style="display: flex; align-items: center; gap: 8px;">\n              <div style="width: 20px; height: 20px; background: ${this.colorScale(a)}; border-radius: 2px;"></div>\n              <span style="font-size: 12px;">${r(a)}</span>\n            </div>\n          `}).join("")}\n        ${n?'\n          <div style="display: flex; align-items: center; gap: 8px;">\n            <div style="width: 20px; height: 20px; background: #f1f5f9; border-radius: 2px; border: 1px solid #e2e8f0;"></div>\n            <span style="font-size: 12px;">NC</span>\n          </div>\n        ':""}\n      </div>\n    `},handleMouseOver(t,e){const a=e.properties.code,n=e.properties.nom,r=DataProcessor.getStats().byDepartment[a];d3.select(t.target).attr("stroke","#1e40af").attr("stroke-width",2);let s=`<strong>${n} (${a})</strong><br>`;r?(s+=`Offres: ${r.count}<br>`,r.salaryStats&&r.salaryStats.median?s+=`Salaire m√©dian: ${SalaryUtils.formatCurrency(r.salaryStats.median,!0)} (n=${r.salaryStats.count})`:s+="Salaire m√©dian: NC"):s+="Aucune offre",this.tooltip.html(s).style("left",t.pageX+10+"px").style("top",t.pageY-28+"px").style("opacity",1)},handleMouseOut(){this.svg.selectAll(".department").attr("stroke","#fff").attr("stroke-width",.5),this.tooltip.style("opacity",0)},handleClick(t){const e=t.properties.code,a=this.selectedDepts.indexOf(e);a>=0?this.selectedDepts.splice(a,1):this.selectedDepts.length<3&&this.selectedDepts.push(e),this.updateComparison()},updateComparison(){const t=document.getElementById("comparison-cards");if(!t)return;if(0===this.selectedDepts.length)return void(t.innerHTML='<p class="text-muted">Aucun d√©partement s√©lectionn√©</p>');const e=DataProcessor.getStats();t.innerHTML=this.selectedDepts.map(t=>{const a=e.byDepartment[t],n=DataProcessor.getData().departments[t]||t;return a?`\n        <div class="comparison-card" style="background: var(--color-surface-alt); border-radius: var(--radius-md); padding: var(--spacing-md);">\n          <h4 style="margin-bottom: 8px;">${n} (${t})</h4>\n          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">\n            <div>\n              <span style="color: var(--color-text-muted);">Offres</span><br>\n              <strong>${a.count}</strong>\n            </div>\n            <div>\n              <span style="color: var(--color-text-muted);">Salaire m√©dian</span><br>\n              <strong>${a.salaryStats&&a.salaryStats.median?`${SalaryUtils.formatCurrency(a.salaryStats.median,!0)} <span class="count-badge">(n=${a.salaryStats.count})</span>`:"NC"}</strong>\n            </div>\n          </div>\n          <button onclick="FranceMap.removeFromComparison('${t}')" class="btn btn-secondary" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">Retirer</button>\n        </div>\n      `:`\n          <div class="comparison-card" style="background: var(--color-surface-alt); border-radius: var(--radius-md); padding: var(--spacing-md);">\n            <h4>${n} (${t})</h4>\n            <p>Aucune donn√©e</p>\n            <button onclick="FranceMap.removeFromComparison('${t}')" class="btn btn-secondary" style="margin-top: 8px; padding: 4px 8px; font-size: 12px;">Retirer</button>\n          </div>\n        `}).join("")},removeFromComparison(t){const e=this.selectedDepts.indexOf(t);e>=0&&(this.selectedDepts.splice(e,1),this.updateComparison())},setColorMode(t){this.colorMode=t,this.update()}};window.FranceMap=FranceMap;const SalaryUtils={RATES:{cadre:.75,nonCadre:.78},formatCurrency:(t,e=!1)=>null==t||0===t?e?"NC":"Non renseign√©":new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(t),formatNumber:t=>null==t?"-":new Intl.NumberFormat("fr-FR").format(t),getSalary(t,e="gross",a="annual"){if(!t)return null;return t[`salary${e.charAt(0).toUpperCase()+e.slice(1)}${a.charAt(0).toUpperCase()+a.slice(1)}`]||null},getLabel:(t,e)=>`${{gross:"Brut",net:"Net"}[t]} ${{annual:"annuel",monthly:"mensuel"}[e]}`,grossToNet(t,e=!1){if(null==t)return null;const a=e?this.RATES.cadre:this.RATES.nonCadre;return Math.round(t*a)},netToGross(t,e=!1){if(null==t)return null;const a=e?this.RATES.cadre:this.RATES.nonCadre;return Math.round(t/a)},annualToMonthly:(t,e=12)=>null==t?null:Math.round(t/e),monthlyToAnnual:(t,e=12)=>null==t?null:Math.round(t*e),calculateStats(t){const e=t.filter(t=>null!=t&&!isNaN(t));if(0===e.length)return null;const a=e.sort((t,e)=>t-e),n=a.length;return{count:n,min:a[0],max:a[n-1],median:n%2==0?(a[n/2-1]+a[n/2])/2:a[Math.floor(n/2)],q1:a[Math.floor(.25*n)],q3:a[Math.floor(.75*n)],mean:e.reduce((t,e)=>t+e,0)/n}}};window.SalaryUtils=SalaryUtils;const JobClassifier={families:[{name:"Professeur Documentaliste",icon:"üéì",color:"#8b5cf6",description:"Enseignement et formation en documentation"},{name:"Archiviste",icon:"üìö",color:"#06b6d4",description:"Gestion et conservation des archives"},{name:"Record Manager",icon:"üóÉÔ∏è",color:"#84cc16",description:"Gestion des documents d'activit√©"},{name:"Knowledge Manager",icon:"üí°",color:"#f59e0b",description:"Gestion des connaissances en entreprise"},{name:"Document Controller",icon:"‚úÖ",color:"#10b981",description:"Contr√¥le et suivi documentaire projet"},{name:"Veille",icon:"üîç",color:"#ec4899",description:"Veille strat√©gique et intelligence √©conomique"},{name:"M√©diath√©caire/Biblioth√©caire",icon:"üìñ",color:"#6366f1",description:"Animation de m√©diath√®ques et biblioth√®ques"},{name:"Directeur/Directrice",icon:"üëî",color:"#1e40af",description:"Direction de services documentaires"},{name:"Responsable",icon:"üìã",color:"#0891b2",description:"Responsabilit√© d'√©quipe ou de projet"},{name:"Gestionnaire",icon:"üóÑÔ∏è",color:"#65a30d",description:"Gestion de bases de donn√©es et fonds documentaires"},{name:"Assistant(e)",icon:"ü§ù",color:"#f97316",description:"Assistance documentaire et administrative"},{name:"Documentaliste",icon:"üìÑ",color:"#2563eb",description:"Documentation g√©n√©raliste"}],getFamily(t){return this.families.find(e=>e.name===t)||this.families[this.families.length-1]},getAllFamilyNames(){return this.families.map(t=>t.name)},getColor(t){const e=this.getFamily(t);return e?e.color:"#64748b"},getIcon(t){const e=this.getFamily(t);return e?e.icon:"üìÑ"},getColorPalette(){return this.families.map(t=>t.color)}};window.JobClassifier=JobClassifier;const OffersModal={modal:null,currentOffers:[],currentPage:1,perPage:20,context:"",sortColumn:null,sortDirection:"asc",loadedCount:0,loadItemsPerScroll:20,isLoading:!1,scrollHandler:null,isMobile:()=>window.innerWidth<768,init(){if(this.modal)return;document.body.insertAdjacentHTML("beforeend",'\n      <div id="offers-modal" class="offers-modal-overlay" style="display: none;">\n        <div class="offers-modal-content">\n          <div class="offers-modal-header">\n            <div>\n              <h2>Offres correspondantes <span class="offers-modal-count"></span></h2>\n              <span class="offers-modal-context"></span>\n            </div>\n            <button class="offers-modal-close" aria-label="Fermer">&times;</button>\n          </div>\n          <div class="offers-modal-body">\n            <div class="offers-modal-stats"></div>\n            <div class="offers-table-container">\n              <table class="offers-table">\n                <thead>\n                  <tr>\n                    <th class="sortable" data-sort="title">Poste <span class="sort-icon"></span></th>\n                    <th class="sortable" data-sort="company">Entreprise <span class="sort-icon"></span></th>\n                    <th class="sortable" data-sort="department">Lieu <span class="sort-icon"></span></th>\n                    <th class="sortable" data-sort="contractType">Contrat <span class="sort-icon"></span></th>\n                    <th class="sortable" data-sort="salaryNetMonthly">Salaire <span class="sort-icon"></span></th>\n                    <th></th>\n                  </tr>\n                </thead>\n                <tbody></tbody>\n              </table>\n            </div>\n            <div class="offers-modal-pagination"></div>\n          </div>\n        </div>\n      </div>\n    '),this.modal=document.getElementById("offers-modal"),this.modal.querySelector(".offers-modal-close").addEventListener("click",()=>this.hide()),this.modal.addEventListener("click",t=>{t.target===this.modal&&this.hide()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"none"!==this.modal.style.display&&this.hide()}),this.modal.querySelectorAll(".sortable").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort;this.toggleSort(e)})})},toggleSort(t){this.sortColumn===t?this.sortDirection="asc"===this.sortDirection?"desc":"asc":(this.sortColumn=t,this.sortDirection="asc"),this.sortOffers(),this.currentPage=1,this.renderTable(),this.renderPagination(),this.updateSortIcons()},sortOffers(){if(!this.sortColumn)return;const t=this.sortColumn,e="asc"===this.sortDirection?1:-1;this.currentOffers.sort((a,n)=>{let r=a[t],s=n[t];return null==r&&null==s?0:null==r?1:null==s?-1:"salaryNetMonthly"===t?(r-s)*e:(r=String(r).toLowerCase(),s=String(s).toLowerCase(),r.localeCompare(s,"fr")*e)})},updateSortIcons(){this.modal.querySelectorAll(".sortable").forEach(t=>{const e=t.querySelector(".sort-icon");t.dataset.sort===this.sortColumn?(e.textContent="asc"===this.sortDirection?" ‚ñ≤":" ‚ñº",t.classList.add("sorted")):(e.textContent=" ‚áÖ",t.classList.remove("sorted"))})},setupInfiniteScroll(){if(!this.isMobile())return;const t=this.modal.querySelector(".offers-table-container");this.scrollHandler&&t.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=()=>{if(this.isLoading)return;if(this.loadedCount>=this.currentOffers.length)return;const{scrollTop:e,scrollHeight:a,clientHeight:n}=t;e+n>=a-100&&this.loadMoreItems()},t.addEventListener("scroll",this.scrollHandler)},loadMoreItems(){this.loadedCount>=this.currentOffers.length||(this.isLoading=!0,this.showLoadingIndicator(),setTimeout(()=>{const t=this.modal.querySelector(".offers-table tbody"),e=this.loadedCount,a=Math.min(e+this.loadItemsPerScroll,this.currentOffers.length),n=this.currentOffers.slice(e,a);t.insertAdjacentHTML("beforeend",this.renderOfferRows(n)),this.loadedCount=a,this.isLoading=!1,this.hideLoadingIndicator(),this.updateLoadedCount()},150))},renderOfferRows(t){const e=this.isMobile();return t.map(t=>{const a=t.salaryNetMonthly?SalaryUtils.formatCurrency(t.salaryNetMonthly)+"/mois":"-",n=t.company||"-",r=e?t.department||"-":t.departmentName?`${t.departmentName} (${t.department})`:t.department||"-",s=t.url||"#";return`\n        <tr>\n          <td class="offer-title">\n            ${e?`<span class="offer-family-badge" style="background: ${JobClassifier.getColor(t.jobFamily)}20; color: ${JobClassifier.getColor(t.jobFamily)};">\n            ${t.jobFamily}\n           </span>`:`<span class="offer-family-badge" style="background: ${JobClassifier.getColor(t.jobFamily)}20; color: ${JobClassifier.getColor(t.jobFamily)};">\n            ${t.jobFamily}\n           </span>\n           <span title="${this.escapeHtml(t.title)}">${this.truncate(t.title,50)}</span>`}\n          </td>\n          <td>${this.escapeHtml(n)}</td>\n          <td>${r}</td>\n          <td><span class="contract-badge">${this.escapeHtml(t.contractType||"-")}</span></td>\n          <td>${a}</td>\n          <td>\n            ${"#"!==s?`<a href="${s}" target="_blank" rel="noopener" class="offer-link">Voir</a>`:""}\n          </td>\n        </tr>\n      `}).join("")},showLoadingIndicator(){if(!this.modal.querySelector(".infinite-scroll-loading")){this.modal.querySelector(".offers-table-container").insertAdjacentHTML("beforeend",'\n        <div class="infinite-scroll-loading">\n          <span class="loading-spinner"></span>\n          Chargement...\n        </div>\n      ')}},hideLoadingIndicator(){const t=this.modal.querySelector(".infinite-scroll-loading");t&&t.remove()},updateLoadedCount(){const t=this.modal.querySelector(".loaded-count");t&&(t.textContent=`${this.loadedCount} / ${this.currentOffers.length}`)},show(t,e=""){this.init(),this.currentOffers=[...t],this.currentPage=1,this.loadedCount=0,this.isLoading=!1,this.context=e,this.sortColumn=null,this.sortDirection="asc",this.modal.querySelector(".offers-modal-context").textContent=e;const a=t.length.toLocaleString("fr-FR");this.modal.querySelector(".offers-modal-count").textContent=`(${a})`;const n=t.filter(t=>t.salaryNetMonthly).length,r=this.isMobile();this.modal.querySelector(".offers-modal-stats").innerHTML=r?`\n        <span><strong>${t.length}</strong> offres</span>\n        <span><strong>${n}</strong> avec salaire</span>\n        <span class="loaded-count"></span>\n      `:`\n        <span><strong>${t.length}</strong> offres</span>\n        <span><strong>${n}</strong> avec salaire</span>\n      `,this.renderTable(),this.renderPagination(),this.updateSortIcons(),r&&(this.setupInfiniteScroll(),this.updateLoadedCount()),this.modal.style.display="flex",document.body.style.overflow="hidden"},hide(){this.modal&&(this.modal.style.display="none",document.body.style.overflow="")},renderTable(){const t=this.modal.querySelector(".offers-table tbody");let e;if(this.isMobile()){const t=Math.min(this.loadItemsPerScroll,this.currentOffers.length);e=this.currentOffers.slice(0,t),this.loadedCount=t}else{const t=(this.currentPage-1)*this.perPage,a=t+this.perPage;e=this.currentOffers.slice(t,a)}0!==e.length?t.innerHTML=this.renderOfferRows(e):t.innerHTML='\n        <tr>\n          <td colspan="6" style="text-align: center; padding: 2rem; color: var(--color-text-muted);">\n            Aucune offre correspondante\n          </td>\n        </tr>\n      '},renderPagination(){const t=this.modal.querySelector(".offers-modal-pagination");if(this.isMobile())return void(t.innerHTML="");const e=Math.ceil(this.currentOffers.length/this.perPage);if(e<=1)return void(t.innerHTML="");let a='<div class="pagination-controls">';a+=`<button class="pagination-btn" ${1===this.currentPage?"disabled":""} data-page="${this.currentPage-1}">&laquo; Pr√©c.</button>`;let n=Math.max(1,this.currentPage-Math.floor(2.5)),r=Math.min(e,n+5-1);r-n<4&&(n=Math.max(1,r-5+1)),n>1&&(a+='<button class="pagination-btn" data-page="1">1</button>',n>2&&(a+='<span class="pagination-ellipsis">...</span>'));for(let t=n;t<=r;t++)a+=`<button class="pagination-btn ${t===this.currentPage?"active":""}" data-page="${t}">${t}</button>`;r<e&&(r<e-1&&(a+='<span class="pagination-ellipsis">...</span>'),a+=`<button class="pagination-btn" data-page="${e}">${e}</button>`),a+=`<button class="pagination-btn" ${this.currentPage===e?"disabled":""} data-page="${this.currentPage+1}">Suiv. &raquo;</button>`,a+="</div>",t.innerHTML=a,t.querySelectorAll(".pagination-btn").forEach(t=>{t.addEventListener("click",()=>{const a=parseInt(t.dataset.page);a&&a!==this.currentPage&&a>=1&&a<=e&&(this.currentPage=a,this.renderTable(),this.renderPagination(),this.modal.querySelector(".offers-table-container").scrollTop=0)})})},truncate:(t,e)=>t?t.length>e?t.substring(0,e)+"...":t:"",escapeHtml(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}};window.OffersModal=OffersModal;const BottomSheet=function(){let t=null,e=null,a=null,n=null,r=null,s=null,o=null,i=null,l=!1,c=0,d=0,u=!1,p={},h={jobFamilies:[],contractTypes:[],departments:[]};function m(){const t=document.querySelector(".filters-container");if(!t||!a)return;t.querySelectorAll(".filter-group").forEach(t=>{const e=t.cloneNode(!0),n=e.querySelector("[id]")?.id;n&&(e.querySelectorAll("[id]").forEach(t=>{t.id=`bottom-sheet-${t.id}`}),e.querySelectorAll("[for]").forEach(t=>{t.setAttribute("for",`bottom-sheet-${t.getAttribute("for")}`)})),a.appendChild(e)}),function(){if(!a)return;const t=t=>{if(!t)return;const e=t.querySelector(".filter-chips"),a=t.querySelector(".filter-dropdown-menu"),n=t.querySelector(".filter-dropdown-trigger");if(!e||!a||!n)return;const r=a.querySelectorAll("input:checked");n.textContent=r.length>0?`${r.length} s√©lectionn√©${r.length>1?"s":""}`:"S√©lectionner...",n.style.borderColor=r.length>0?"var(--color-primary)":"",e.innerHTML=Array.from(r).map(t=>`\n             <span class="filter-chip">\n               ${t.parentElement.textContent.replace("‚óè","").trim()}\n               <button class="filter-chip-remove" data-value="${t.value}">&times;</button>\n             </span>\n           `).join(""),e.querySelectorAll(".filter-chip-remove").forEach(t=>{t.addEventListener("click",t=>{t.stopPropagation();const e=t.target.dataset.value,n=a.querySelector(`input[value="${e}"]`);n&&(n.checked=!1,n.dispatchEvent(new Event("change",{bubbles:!0})))})})},e=a.querySelector('[id*="filter-job-family"]');e&&e.addEventListener("change",e=>{if("checkbox"===e.target.type){const a=e.target.value;e.target.checked?h.jobFamilies.includes(a)||h.jobFamilies.push(a):h.jobFamilies=h.jobFamilies.filter(t=>t!==a),t(e.target.closest(".multi-select-container"))}});const n=a.querySelector('[id*="filter-contract"]');n&&n.addEventListener("change",e=>{if("checkbox"===e.target.type){const a=e.target.value;e.target.checked?h.contractTypes.includes(a)||h.contractTypes.push(a):h.contractTypes=h.contractTypes.filter(t=>t!==a),t(e.target.closest(".multi-select-container"))}});!function(){const t=a.querySelector('[id*="dept-search"]'),e=a.querySelector('[id*="dept-dropdown"]'),n=a.querySelector('[id*="dept-chips"]');if(!t||!e||!n)return;let r=-1;const s=()=>{n.innerHTML=h.departments.map(t=>{const e=p[t]||t;return`\n          <span class="dept-chip" data-code="${t}">\n            ${e} (${t})\n            <button class="dept-chip-remove" aria-label="Retirer ${e}">&times;</button>\n          </span>\n        `}).join(""),n.querySelectorAll(".dept-chip-remove").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.closest(".dept-chip").dataset.code;h.departments=h.departments.filter(t=>t!==e),s()})})},o=t=>{if(!t||t.length<1)return void(e.hidden=!0);const a=Object.entries(p).filter(([e,a])=>!h.departments.includes(e)&&(e.toLowerCase().includes(t)||a.toLowerCase().includes(t))).slice(0,8);0===a.length?e.innerHTML='<div class="dept-no-results">Aucun r√©sultat</div>':e.innerHTML=a.map(([t,e],a)=>`\n          <div class="dept-option ${a===r?"highlighted":""}"\n               data-code="${t}"\n               data-index="${a}"\n               role="option">\n            <span class="dept-option-code">${t}</span>\n            ${e}\n          </div>\n        `).join(""),e.hidden=!1,e.querySelectorAll(".dept-option").forEach(t=>{t.addEventListener("click",()=>i(t.dataset.code))})},i=a=>{h.departments.includes(a)||h.departments.push(a),t.value="",e.hidden=!0,r=-1,s()};let l;t.addEventListener("input",t=>{clearTimeout(l),l=setTimeout(()=>{r=-1,o(t.target.value.toLowerCase())},100)}),t.addEventListener("keydown",t=>{const a=e.querySelectorAll(".dept-option");if("ArrowDown"===t.key)t.preventDefault(),r=Math.min(r+1,a.length-1),c(a);else if("ArrowUp"===t.key)t.preventDefault(),r=Math.max(r-1,0),c(a);else if("Enter"===t.key&&r>=0){t.preventDefault();const e=a[r]?.dataset.code;e&&i(e)}else"Escape"===t.key&&(e.hidden=!0,r=-1)});const c=t=>{t.forEach((t,e)=>{t.classList.toggle("highlighted",e===r)})};a.addEventListener("click",t=>{t.target.closest(".dept-autocomplete")||(e.hidden=!0)}),t.addEventListener("focus",()=>{t.value.length>=1&&o(t.value.toLowerCase())}),a._renderDeptChips=s}()}(),function(){if(!a)return;a.querySelectorAll(".multi-select-container").forEach(t=>{const e=t.querySelector(".filter-dropdown-trigger"),n=t.querySelector(".filter-dropdown-menu");e&&n&&e.addEventListener("click",t=>{t.stopPropagation();const e=n.classList.contains("active");a.querySelectorAll(".filter-dropdown-menu").forEach(t=>t.classList.remove("active")),e||n.classList.add("active")})}),a.addEventListener("click",t=>{t.target.closest(".filter-dropdown-wrapper")||a.querySelectorAll(".filter-dropdown-menu").forEach(t=>t.classList.remove("active"))})}()}function f(){t&&e?(!function(){const t=DataProcessor.filters;h={jobFamilies:[...t.jobFamilies],contractTypes:[...t.contractTypes],departments:[...t.departments]},a&&(a.querySelectorAll('[id$="filter-job-family"] input[type="checkbox"]').forEach(t=>{t.checked=h.jobFamilies.includes(t.value)}),a.querySelectorAll('[id$="filter-contract"] input[type="checkbox"]').forEach(t=>{t.checked=h.contractTypes.includes(t.value)}),a._renderDeptChips&&a._renderDeptChips())}(),l=!0,t.hidden=!1,e.hidden=!1,requestAnimationFrame(()=>{t.classList.add("open"),e.classList.add("visible")}),document.body.style.overflow="hidden",n?.focus()):console.error("[BottomSheet] Open failed: Elements not found",{sheetEl:t,overlayEl:e})}function y(){t&&e&&(l=!1,t.classList.remove("open"),e.classList.remove("visible"),setTimeout(()=>{t.hidden=!0,e.hidden=!0},300),document.body.style.overflow="",o?.focus())}function g(e){const a=t.querySelector(".bottom-sheet-handle"),n=t.querySelector(".bottom-sheet-header");(a?.contains(e.target)||n?.contains(e.target))&&(u=!0,c=e.touches[0].clientY,d=c,t.style.transition="none")}function b(e){if(!u)return;d=e.touches[0].clientY;const a=d-c;a>0&&(e.preventDefault(),t.style.transform=`translateY(${a}px)`)}function v(){if(!u)return;u=!1,t.style.transition="",t.style.transform="";d-c>100&&y()}function S(){h={jobFamilies:[],contractTypes:[],departments:[]},a&&a.querySelectorAll('input[type="checkbox"]').forEach(t=>{t.checked=!1});const t=a?.querySelector('[id*="dept-search"]'),e=a?.querySelector('[id*="dept-dropdown"]');t&&(t.value=""),e&&(e.hidden=!0),a._renderDeptChips&&a._renderDeptChips(),a&&(a.querySelectorAll(".filter-chips").forEach(t=>{t.innerHTML=""}),a.querySelectorAll(".filter-dropdown-trigger").forEach(t=>{t.textContent="S√©lectionner...",t.style.borderColor=""})),w()}function w(){DataProcessor.applyFilters(h),function(){if(document.querySelectorAll('#filter-job-family input[type="checkbox"]').forEach(t=>{t.checked=h.jobFamilies.includes(t.value)}),document.querySelectorAll('#filter-contract input[type="checkbox"]').forEach(t=>{t.checked=h.contractTypes.includes(t.value)}),window.App){App.selectedDepts=new Set(h.departments);const t=document.getElementById("dept-chips");t&&(t.innerHTML=h.departments.map(t=>{const e=p[t]||t;return`\n            <span class="dept-chip" data-code="${t}">\n              ${e} (${t})\n              <button class="dept-chip-remove" aria-label="Retirer ${e}">&times;</button>\n            </span>\n          `}).join(""),t.querySelectorAll(".dept-chip-remove").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.closest(".dept-chip"),a=e.dataset.code;App.selectedDepts.delete(a),e.remove(),App.applyFilters()})}))}}(),y()}function E(){if(!i)return;const t=DataProcessor.filters,e=t.jobFamilies.length+t.contractTypes.length+t.departments.length;e>0?(i.textContent=e,i.hidden=!1):i.hidden=!0}function C(){a&&(a.innerHTML="",m(),console.log("[BottomSheet] Filters refreshed"))}return{init:function(){if(t=document.getElementById("bottom-sheet"),e=document.getElementById("bottom-sheet-overlay"),a=document.getElementById("bottom-sheet-content"),n=document.getElementById("bottom-sheet-close"),r=document.getElementById("bottom-sheet-reset"),s=document.getElementById("bottom-sheet-apply"),o=document.getElementById("mobile-filter-btn"),i=document.getElementById("filter-badge"),!t)return void console.warn("[BottomSheet] Sheet element not found");o?.addEventListener("click",f),n?.addEventListener("click",y),e?.addEventListener("click",y),r?.addEventListener("click",S),s?.addEventListener("click",w),t.addEventListener("touchstart",g,{passive:!0}),t.addEventListener("touchmove",b,{passive:!1}),t.addEventListener("touchend",v,{passive:!0}),document.addEventListener("keydown",t=>{"Escape"===t.key&&l&&y()}),window.addEventListener("dataFiltered",E);const c=document.querySelector(".filters-container"),d=c?.querySelectorAll('input[type="checkbox"]');if(!d||0===d.length)return console.warn("[BottomSheet] Filters not yet populated, deferring initialization"),void window.addEventListener("filtersReady",()=>{console.log("[BottomSheet] Filters ready, refreshing content"),C()},{once:!0});m(),console.log("[BottomSheet] Initialized")},open:f,close:y,isOpen:function(){return l},updateBadge:E,refreshFilters:C,setDepartmentData:function(t){p=t||{},console.log("[BottomSheet] Department data set:",Object.keys(p).length,"departments")}}}();window.BottomSheet=BottomSheet;const Timeline={chart:null,init(){const t=document.getElementById("chart-timeline");t&&(this.chart&&this.chart.destroy(),this.chart=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"Nombre d'offres",data:[],borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,interaction:{intersect:!1,mode:"index"},plugins:{legend:{display:!1},tooltip:{callbacks:{title:t=>new Date(t[0].label).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}}},scales:{x:{ticks:{callback:function(t,e){return new Date(this.getLabelForValue(t)).toLocaleDateString("fr-FR",{month:"short"})},maxTicksLimit:12}},y:{beginAtZero:!0,ticks:{precision:0}}}}}),this.update())},update(){if(!this.chart)return;const t=DataProcessor.getData();if(!t)return;const e=DataProcessor.getOffersByDate(),a=t.dates.sort(),n=a.map(t=>(e[t]||[]).length);this.chart.data.labels=a,this.chart.data.datasets[0].data=n,this.chart.update()}};window.Timeline=Timeline;const DossierMetiers={init(){this.update()},update(){const t=document.getElementById("dossier-grid");if(!t)return;const e=DataProcessor.getStats(),a=Object.entries(e.byJobFamily).sort((t,e)=>e[1].count-t[1].count);t.innerHTML=a.map(([t,e])=>{const a=JobClassifier.getFamily(t),n=e.salaryStats,r=this.getTopEmployersForFamily(t);return`\n        <div class="dossier-card">\n          <h4>${a.icon} ${t}</h4>\n          <p style="color: var(--color-text-muted); font-size: 14px; margin-bottom: 16px;">${a.description}</p>\n\n          <div class="dossier-stats">\n            <div class="dossier-stat">\n              <span class="dossier-stat-value">${e.count}</span>\n              <span class="dossier-stat-label">Offres</span>\n            </div>\n            <div class="dossier-stat">\n              <span class="dossier-stat-value">${n?n.count:0}</span>\n              <span class="dossier-stat-label">Avec salaire</span>\n            </div>\n          </div>\n\n          ${n?`\n            <div class="dossier-salary">\n              <h5>Fourchette de salaires (brut annuel)</h5>\n              <div class="salary-range">\n                <span>${SalaryUtils.formatCurrency(n.min)}</span>\n                <div class="salary-bar"></div>\n                <span>${SalaryUtils.formatCurrency(n.max)}</span>\n              </div>\n              <p style="text-align: center; margin-top: 8px; font-size: 14px;">\n                M√©diane: <strong style="color: var(--color-primary);">${SalaryUtils.formatCurrency(n.median)}</strong>\n              </p>\n            </div>\n          `:'\n            <div class="dossier-salary">\n              <p style="color: var(--color-text-muted); font-style: italic;">Donn√©es salariales insuffisantes</p>\n            </div>\n          '}\n\n          ${r.length>0?`\n            <div class="dossier-employers">\n              <h5>Principaux recruteurs</h5>\n              <div class="employer-tags">\n                ${r.slice(0,5).map(t=>`\n                  <span class="employer-tag">${t.name} (${t.count})</span>\n                `).join("")}\n              </div>\n            </div>\n          `:""}\n\n          <button class="btn btn-cta" data-job-family="${t}">D√©couvrir la typologie de ces offres (pass√©es)</button>\n        </div>\n      `}).join(""),t.querySelectorAll(".btn-cta[data-job-family]").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.jobFamily,a=DataProcessor.getOffers(!0).filter(t=>t.jobFamily===e);OffersModal.show(a,`Famille: ${e}`)})})},getTopEmployersForFamily(t){const e=DataProcessor.getOffers().filter(e=>e.jobFamily===t),a={};return e.forEach(t=>{t.company&&(a[t.company]=(a[t.company]||0)+1)}),Object.entries(a).sort((t,e)=>e[1]-t[1]).slice(0,5).map(([t,e])=>({name:t,count:e}))}};window.DossierMetiers=DossierMetiers;const ErrorToast=function(){let t=null;const e={network:"Une erreur r√©seau s'est produite. Veuillez v√©rifier votre connexion.",data:"Impossible de charger les donn√©es. Veuillez r√©essayer.",filter:"Erreur lors de l'application des filtres.",unknown:"Une erreur inattendue s'est produite."};function a(){t||(t=document.createElement("div"),t.className="error-toast-container",t.setAttribute("role","alert"),t.setAttribute("aria-live","polite"),document.body.appendChild(t),console.log("[ErrorToast] Initialized"))}function n(e,n=5e3){t||a();const s=document.createElement("div");s.className="error-toast",s.innerHTML=`\n      <div class="error-toast-icon" aria-hidden="true">\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <circle cx="12" cy="12" r="10"></circle>\n          <line x1="12" y1="8" x2="12" y2="12"></line>\n          <line x1="12" y1="16" x2="12.01" y2="16"></line>\n        </svg>\n      </div>\n      <div class="error-toast-content">\n        <strong>Oups, nous sommes d√©sol√©s !</strong>\n        <p>${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(e)}</p>\n      </div>\n      <button class="error-toast-close" aria-label="Fermer">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <line x1="18" y1="6" x2="6" y2="18"></line>\n          <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>\n      </button>\n    `;return s.querySelector(".error-toast-close").addEventListener("click",()=>r(s)),t.appendChild(s),requestAnimationFrame(()=>{s.classList.add("visible")}),n>0&&setTimeout(()=>r(s),n),s}function r(t){t&&t.parentNode&&(t.classList.remove("visible"),t.classList.add("dismissing"),setTimeout(()=>{t.parentNode&&t.remove()},300))}return{init:a,show:n,dismiss:r,showNetworkError:function(t=8e3){return n(e.network,t)},showDataError:function(t=8e3){return n(e.data,t)},showFilterError:function(t=5e3){return n(e.filter,t)},showUnknownError:function(t=5e3){return n(e.unknown,t)},messages:e}}();window.ErrorToast=ErrorToast;const UpdateToast=function(){let t=null,e=null,a=null,n=null,r=null,s=5;function o(){t&&(t.hidden=!1,t.classList.add("visible"),s=5,i(),r=setInterval(()=>{s--,i(),s<=0&&c()},1e3))}function i(){e&&(e.textContent=`Rechargement dans ${s}s...`)}function l(){r&&(clearInterval(r),r=null),t&&(t.classList.remove("visible"),setTimeout(()=>{t.hidden=!0},300))}function c(){r&&(clearInterval(r),r=null),window.location.reload()}return{init:function(){t=document.getElementById("update-toast"),e=document.getElementById("update-countdown"),a=document.getElementById("update-reload"),n=document.getElementById("update-dismiss"),t?(a?.addEventListener("click",()=>{c()}),n?.addEventListener("click",()=>{l()}),window.addEventListener("swUpdated",t=>{console.log("[UpdateToast] Service Worker updated",t.detail),o()}),console.log("[UpdateToast] Initialized")):console.warn("[UpdateToast] Toast element not found")},show:o,dismiss:l,reload:c,isVisible:function(){return t&&!t.hidden}}}();window.UpdateToast=UpdateToast;const SwipeNavigation=function(){let t=null,e=null,a=0,n=0,r=0,s=0,o=!1,i=!1;const l=["overview","salaries","map","sectors","dossier"];function c(e){if(window.BottomSheet&&BottomSheet.isOpen())return;const a=e.target;(function(e){const a=["BUTTON","A","INPUT","SELECT","TEXTAREA"],n=["button","link","checkbox","radio","slider"];let r=e;for(;r&&r!==t;){if(a.includes(r.tagName))return!0;const t=r.getAttribute("role");if(t&&n.includes(t))return!0;if(r.onclick||r.hasAttribute("data-clickable"))return!0;r=r.parentElement}return!1})(a)||function(e){let a=e;for(;a&&a!==t;){if("CANVAS"===a.tagName)return!0;if("SVG"===a.tagName||"svg"===a.tagName)return!0;if("france-map"===a.id||"sector-treemap"===a.id)return!0;if(a.classList.contains("chart-card"))return!1;a=a.parentElement}return!1}(a)||(n=e.touches[0].clientX,r=e.touches[0].clientY,s=Date.now(),o=!0,i=!1)}function d(e){if(!o)return;const a=e.touches[0].clientX,s=e.touches[0].clientY,l=a-n,c=s-r,d=Math.abs(l),u=Math.abs(c);u>.75*d&&u>10?o=!1:!function(e){let a=e;for(;a&&a!==t;){if(a.classList&&(a.classList.contains("salary-table-container")||a.classList.contains("horizontal-scroll-container"))&&a.scrollWidth>a.clientWidth)return!0;if("TABLE"===a.tagName){const t=a.parentElement;if(t&&t.scrollWidth>t.clientWidth)return!0}a=a.parentElement}return!1}(e.target)?d>10&&(i=!0,e.preventDefault()):o=!1}function u(t){if(!o||!i)return void(o=!1);const e=t.changedTouches[0].clientX,a=t.changedTouches[0].clientY,l=Date.now(),c=e-n,d=a-r,u=l-s,m=Math.abs(c)/u;Math.abs(c)>50&&m>.3&&Math.abs(d)<.75*Math.abs(c)&&(c<0?p():h()),o=!1,i=!1}function p(){a<l.length-1&&(a++,m(l[a]))}function h(){a>0&&(a--,m(l[a]))}function m(t){const e=document.querySelector(`.tab-btn[data-tab="${t}"]`);e&&(e.click(),e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}))}return{init:function(){t=document.querySelector(".content-area"),e=document.querySelectorAll(".tab-btn"),t?(!function(){const t=document.querySelector(".tab-btn.active");if(t){const e=t.dataset.tab;a=l.indexOf(e),-1===a&&(a=0)}}(),t.addEventListener("touchstart",c,{passive:!0}),t.addEventListener("touchmove",d,{passive:!1}),t.addEventListener("touchend",u,{passive:!0}),e.forEach((t,e)=>{t.addEventListener("click",()=>{a=e})}),console.log("[SwipeNavigation] Initialized")):console.warn("[SwipeNavigation] Content area not found")},getCurrentTab:function(){return l[a]},setCurrentTab:function(t){const e=l.indexOf(t);-1!==e&&(a=e)},navigateToNextTab:p,navigateToPreviousTab:h}}();window.SwipeNavigation=SwipeNavigation;const HashRouter=function(){let t="/",e={},a=[];function n(){const a=window.location.hash;if(!a||"#"===a||"#/"===a)return t="/",void(e={});let n=a.substring(1);const[r,s]=n.split("?");t=r||"/",e=s?Object.fromEntries(new URLSearchParams(s)):{}}function r(){n(),o()}function s(t,e={}){let a=t;t.startsWith("/")||(a="/"+t);let r="#"+a;if(Object.keys(e).length>0){r+="?"+new URLSearchParams(e).toString()}window.location.hash=r,n(),o()}function o(){a.forEach(a=>{try{a({path:t,params:e,hash:window.location.hash})}catch(t){console.error("[HashRouter] Callback error:",t)}}),window.dispatchEvent(new CustomEvent("hashRouteChanged",{detail:{path:t,params:e}}))}return{init:function(){window.addEventListener("hashchange",r),n(),o(),console.log("[HashRouter] Initialized")},navigateTo:s,getPath:function(){return t},getParams:function(){return{...e}},getParam:function(t,a=null){return e[t]??a},setParam:function(a,n){const r={...e,[a]:n};s(t,r)},removeParam:function(a){const n={...e};delete n[a],s(t,n)},isPath:function(e){return t===e},isPathLike:function(e){return t.startsWith(e)},onRouteChanged:function(t){return a.push(t),()=>{a=a.filter(e=>e!==t)}},getShareableUrl:function(){return window.location.origin+window.location.pathname+window.location.hash},restoreStateFromUrl:function(){return n(),{path:t,params:e}},replaceState:function(t,e={}){let a=t;t.startsWith("/")||(a="/"+t);let r="#"+a;if(Object.keys(e).length>0){r+="?"+new URLSearchParams(e).toString()}window.history.replaceState(null,"",window.location.pathname+r),n(),o()},handlePathRoute:function(t,e={}){return!0}}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",HashRouter.init):HashRouter.init(),window.HashRouter=HashRouter,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>App.init()):App.init();